#user       www www;  ## Default: nobody
worker_processes  4;  ## Default: 1
#error_log  logs/error.log;
#pid        logs/nginx.pid;
#worker_rlimit_nofile 8192;
events {
  worker_connections  4096;  ## Default: 1024
}
 
http {
  #include    mime.types;
  #include    proxy.conf;
  #include    fastcgi.conf;
  #index    index.html index.htm index.php;
 
  #default_type application/octet-stream;
  #log_format   main '$remote_addr - $remote_user [$time_local]  $status '
  #  '"$request" $body_bytes_sent "$http_referer" '
  #  '"$http_user_agent" "$http_x_forwarded_for"';
  #access_log   logs/access.log  main;
  #sendfile     on;
  #tcp_nopush   on;
  #server_names_hash_bucket_size 128; # this seems to be required for some vhosts
 
 #server { # php/fastcgi
 #   listen       80;
 #   server_name  domain1.com www.domain1.com;
 #   access_log   logs/domain1.access.log  main;
 #   root         html;
# 
#    location ~ \.php$ {
#      fastcgi_pass   127.0.0.1:1025;
#    }
#  }
 
  server {
   listen 80;
   server_name www.formtitan.org;
   rewrite  ^ $scheme://formtitan.org$request_uri permanent;
  }
  
  #helpdesk app
  server {
    listen 80;
    server_name helpdesk.formtitan.org;
    location / {
     proxy_pass http://helpdesk-app;
     proxy_http_version 1.1;
	   proxy_set_header Upgrade $http_upgrade;
	   proxy_set_header Connection 'upgrade';
	   proxy_set_header Host $host;
	   proxy_cache_bypass $http_upgrade;
    }
  }
    
  server {
    listen 80;
    server_name *.formtitan.org;
    location / {
      proxy_pass http://web-app;
      proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection 'upgrade';
	    proxy_set_header Host $host;
	    proxy_cache_bypass $http_upgrade;
    }
  }
   #website app
  #server {
  #  listen 80;
  #  server_name *.formtitan.org;
  #   location / {
  #    proxy_pass http://web-app;
  #    proxy_http_version 1.1;
	#    proxy_set_header Upgrade $http_upgrade;
	#    proxy_set_header Connection 'upgrade';
	#    proxy_set_header Host $host;
	#    proxy_cache_bypass $http_upgrade;
  #  }
  #}
  
  server {
    listen  80 default_server;
    server_name formtitan.org;
    #access_log   logs/domain2.access.log  main;
 
    # serve static files
   # location ~ ^/(images|javascript|js|css|flash|media|static)/  {
   #   root    /var/www/virtual/big.server.com/htdocs;
   #   expires 30d;
   # }
 
    # pass requests for dynamic content to rails/turbogears/zope, et al
     location ~ ^/(FormBuilder|ThemeBuilder) {
      proxy_pass http://web-app;
      proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection 'upgrade';
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-Host $host;
	    proxy_cache_bypass $http_upgrade;
    }
    location ~ ^/logout {
      proxy_pass http://web-app;
    }
    location ~ ^/login {
      if ($request_method = POST ) {
        proxy_pass http://web-app;
      }
    }
    location ~ ^/socket.io/ {
      proxy_pass http://web-app;
    }
    
    location / {
      proxy_pass http://website-app;
      proxy_http_version 1.1;
	    proxy_set_header Upgrade $http_upgrade;
	    proxy_set_header Connection 'upgrade';
	    proxy_set_header Host $host;
	    proxy_cache_bypass $http_upgrade;
    }
   
  }

  upstream helpdesk-app {
    server helpdesk:3000;
  } 
  upstream website-app {
  	server website:3001;
  }
   upstream web-app {
  	server application:3002;
  }
  
  #upstream big_server_com {
  #  server 127.0.0.3:8000 weight=5;
  #  server 127.0.0.3:8001 weight=5;
  #  server 192.168.0.1:8000;
  #  server 192.168.0.1:8001;
  #}
 
  #server { # simple load balancing
  #  listen          80;
  #  server_name     big.server.com;
  #  access_log      logs/big.server.access.log main;
 
  #   location / {
  #     proxy_pass      http://big_server_com;
  #  }
  #}
}